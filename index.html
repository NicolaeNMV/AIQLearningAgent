<!DOCTYPE HTML>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Q-Learning</title>
  <link rel="stylesheet" href="main.css" />
  <link href='http://fonts.googleapis.com/css?family=Lilita+One' rel='stylesheet' type='text/css'>  
  <script type="text/javascript" src="jquery.min.js"></script>
  <script type="text/javascript" src="requestAnimFrame.js"></script>
  <script type="text/javascript" src="ql.js"></script>
  <script type="text/javascript" src="experiment.js"></script>
</head>
<body>
  <div id="wrapper">
    <header>
      <div style="float: right">
        <img src="formula.png" alt="" />
      </div>
      <h1>Q-Learning</h1>
    </header>

    <div style="clear: both"></div>

    <aside>

      <div>
        <blockquote>
        Q-learning is a reinforcement learning technique that works by learning an action-value function that gives the expected utility of taking a given action in a given state and following a fixed policy thereafter.
        </blockquote>
      </div>

      <br />
      

      <div>
        <input type="checkbox" id="enableQL" name="enableQL" checked="checked" />
        <label for="enableQL">visualize QL</label>
        <input type="checkbox" id="enableAnimation" name="enableAnimation" checked="checked" />
        <label for="enableAnimation">animated</label>
      </div>

      <div>
        <label class="prefix" for="width">width</label> <input type="text" class="small" value="30" id="width" />

      <label class="prefix" for="height">height</label> <input type="text" class="small" value="20" id="height" />
      </div>
      <div>
      <label class="prefix" for="n">nb</label> <input type="text" class="small" value="50" id="n" />
      </div>
      <div>
      <label class="prefix" for="alpha">α</label> <input type="text" class="small" value="0.5" id="alpha" />
      <label class="prefix" for="gamma">γ</label> <input type="text" class="small" value="0.95" id="gamma" />
      </div>
      <div>
        <button id="start">start Q-learning</button>
      </div>
    </aside>

    <section>
      <div id="experiment" style="width: 600px; height: 400px;">
        <canvas id="path" width="600" height="400"></canvas>
        <canvas id="viewport" width="600" height="400"></canvas>
        <div id="objects" style="width: 100%; height: 100%"></div>
      </div>
    </section>

    <div id="stats">
      move n°<span class="step">0</span>
    </div>

    <footer>
      a <a href="http://en.wikipedia.org/wiki/Q-learning">Q-learning</a> experiment - by <a href="http://twitter.com/greweb">@greweb</a> and <a href="http://twitter.com/AdrenalinTheOne">@AdrenalinTheOne</a>
    </footer>

  </div>

  <script type="text/javascript">
  $(function(){
  var $canvas = $('#viewport');
  var $path = $('#path');
  var $step = $('#stats .step');
  var $objects = $('#objects');
  var $enableAnimation = $('#enableAnimation');
  var $enableQL = $('#enableQL');

  var n, alpha, gamma, width, height;

  var running;
  var world, worldRenderer, objectsRenderer, robot, robotRenderer;

  $enableQL.on("change", function() {
    if($(this).is(":checked")) {
      $canvas.removeClass('disabled');
      worldRenderer && worldRenderer.startRendering();
    }
    else {
      $canvas.addClass('disabled');
      worldRenderer && worldRenderer.stopRendering();
    }
  }).change();

  $enableAnimation.on("change", function() {
    robot && robot.setAnimated( $(this).is(":checked") );
  }).change();

  function init () {
    robotRenderer && robotRenderer.clean();
    worldRenderer && worldRenderer.clean();
    updateWidth();
    updateHeight();
    updateN();
    updateAlpha();
    updateGamma();
    if (!width || !height) return;

    world = new World(width, height);
    world.generateRandomItems(6, 4);
    worldRenderer = new WorldRenderer(world, $canvas[0]);
    objectsRenderer = new ObjectsRenderer(world, $objects);
    robot = new Robot(world, $enableAnimation.is(':checked'));
    robotRenderer = new RobotRenderer(robot, $path[0]);
  }

  function updateWidth () {
    if (running) return;
    try {
      var w = parseInt($("#width").val());
      if (w !== width) {
        width = w;
        init();
      }
    } catch (e) {}
  }
  function updateHeight () {
    if (running) return;
    try {
      var h = parseInt($("#height").val());
      if (h !== height) {
        height = h;
        init();
      }
    } catch (e) {}
  }
  function updateN () {
    if (running) return;
    try {
      n = parseInt($("#n").val());
    } catch (e) {}
  }
  function updateAlpha () {
    if (running) return;
    try {
      alpha = parseFloat($("#alpha").val());
    } catch (e) {}
  }
  function updateGamma () {
    if (running) return;
    try {
      gamma = parseFloat($("#gamma").val());
    } catch (e) {}
  }

  var ev = "keyup blur";
  $("#width").bind(ev, updateWidth);
  $("#height").bind(ev, updateHeight);
  $("#n").bind(ev, updateN);
  $("#alpha").bind(ev, updateAlpha);
  $("#gamma").bind(ev, updateGamma);

  init();
  var first = true;

  var $start = $("#start");
  $start.removeAttr("disabled");
  $start.click(function () {
    running = true;
    !first && init();
    $start.attr("disabled", "disabled");
    robotRenderer.startRendering();
    robot.E.sub("step", function (i) {
      $step.text(i);
    });
    worldRenderer.startRendering();
    robot.run(function () {
      first = false;
      running = false;
      $start.removeAttr("disabled");
      robotRenderer.stopRendering();
      worldRenderer.stopRendering();
    }, n, alpha, gamma);
  });
});
  </script>
</body>
</html>
